# 12. μ¤ν”„λ§ λ°μ΄ν„° JPA

> π§ μ΄ κΈ€μ€ κΉ€μν•λ‹μ ['μλ°” ORM ν‘μ¤€ JPA ν”„λ΅κ·Έλλ°'](https://www.inflearn.com/course/ORM-JPA-Basic)μ„ κ³µλ¶€ν•λ©° μ •λ¦¬ν• κ²ƒμ„μ„ μ•λ¦½λ‹λ‹¤.

<br>

## 12.1 μ¤ν”„λ§ λ°μ΄ν„° JPA μ†κ°

* μ¤ν”„λ§ λ°μ΄ν„° JPAλ” μ¤ν”„λ§μ—μ„ JPAλ¥Ό νΈλ¦¬ν•κ² μ‚¬μ©ν•  μ μλ„λ΅ μ§€μ›ν•λ” ν”„λ΅μ νΈ
* μ§€λ£¨ν•κ² λ°λ³µλλ” CRUD λ¬Έμ λ¥Ό μ²λ¦¬ν•κΈ° μ„ν•΄ κ³µν†µ μΈν„°νμ΄μ¤λ¥Ό μ κ³µ
* κ°λ°μ‹ μΈν„°νμ΄μ¤λ§ μ‘μ„±ν•λ©΄ μ‹¤ν–‰ μ‹μ μ—μ„ μ¤ν”„λ§ λ°μ΄ν„° JPAκ°€ κµ¬ν„ κ°μ²΄λ¥Ό λ™μ μΌλ΅ μƒμ„±ν•΄μ„ μ£Όμ…  
  **μ¦‰, λ°μ΄ν„° μ ‘κ·Ό κ³„μΈµμ„ κ°λ°ν•  λ• κµ¬ν„ ν΄λμ¤ μ—†μ΄ μΈν„°νμ΄μ¤λ§ μ‘μ„±ν•΄λ„ λ¨**
* κ³µν†µμΌλ΅ μ²λ¦¬ν•  μ μ—†λ” κ°λ°μκ°€ μ§μ ‘ μ •μν• ν”„λ΅νΌν‹°λ΅ κ°’μ„ κ°€μ Έμ¬ λ•λ„ λ©”μ†λ“ μ΄λ¦„μ„ λ¶„μ„ν•μ—¬ μ΄λ¥Ό JPQLλ΅ μ‹¤ν–‰

<br>

## 12.2 μ¤ν”„λ§ λ°μ΄ν„° JPA μ„¤μ •

* `spring-data-jpa` , `spring-data-commons` μμ΅΄μ„± μ¶”κ°€
* XML β†’ `<jpa:repositories>` μ‚¬μ©, λ¦¬ν¬μ§€ν† λ¦¬λ¥Ό κ²€μƒ‰ν•  base-packageλ¥Ό μ‘μ„±
* JavaConfig β†’ `EnableJpaRepositories` μ–΄λ…Έν…μ΄μ… μ¶”κ°€, basePackageμ— λ¦¬ν¬μ§€ν† λ¦¬λ¥Ό κ²€μƒ‰ν•  ν¨ν‚¤μ§€ μ„μΉ μ‘μ„±
* μ¤ν”„λ§ λ°μ΄ν„° JPAλ” μ• ν”λ¦¬μΌ€μ΄μ…μ„ μ‹¤ν–‰ν•  λ• basePackageμ— μλ” λ¦¬ν¬μ§€ν† λ¦¬ μΈν„°νμ΄μ¤λ“¤μ„ μ°Ύμ•„ ν•΄λ‹Ή μΈν„°νμ΄μ¤λ¥Ό κµ¬ν„ν• ν΄λμ¤λ¥Ό λ™μ μΌλ΅ μƒμ„± λ° λΉμΌλ΅ λ“±λ΅

<br>

## 12.3 κ³µν†µ μΈν„°νμ΄μ¤ κΈ°λ¥

* μ¤ν”„λ§ λ°μ΄ν„° JPAλ¥Ό μ‚¬μ©ν•λ” κ°€μ¥ λ‹¨μν• λ°©λ²•μ€ `JpaRepository` μΈν„°νμ΄μ¤λ¥Ό μƒμ† λ°›λ” κ²ƒ

  ```java
  public interface MemberRepository extends JpaRepository<Member, Long> { }
  ```

* `JpaRepository` λ”  `PaginAndSortingRepository` λ¥Ό μƒμ†,  `PaginAndSortingRepository`λ” `CrudRespository`λ¥Ό μƒμ†

* `JpaRepository`λ” JPAμ— νΉν™”λ κΈ°λ¥μ„ μ κ³µ

<br>

## 12.4 μΏΌλ¦¬ λ©”μ†λ“ κΈ°λ¥

### 1. λ©”μ†λ“ μ΄λ¦„μΌλ΅ μΏΌλ¦¬ μƒμ„±

* μΈν„°νμ΄μ¤μ— μ •μν• λ©”μ†λ“λ¥Ό μ‹¤ν–‰ν•λ©΄ μ¤ν”„λ§ λ°μ΄ν„° JPAλ” μ΄λ¥Ό λ¶„μ„ν•μ—¬ JPQLμ„ λ§λ“¤κ³  μ‹¤ν–‰

  ```java
  public interface MemberRepository extends JpaRepository<Member, Long> {
      List<Member> findByEmailAndName(String Email, String name);
      // μ‹¤ν–‰λ JPQL
      // select m from Member m where m.email = ?1 and m.name = ?2
  }
  ```

  μ„μ™€ κ°™μ€ λ©”μ„λ“κ°€ μ΅΄μ¬ν•  μ‹, λ„κΈ΄ μ΄λ©”μΌκ³Ό μ΄λ¦„μΌλ΅ λ νμ›μ„ μ°Ύμ„ μ μμ

* μ •ν•΄μ§„ κ·μΉ™μ΄ μ΅΄μ¬ν•λ©° κ³µμ‹ λ¬Έμ„μ—μ„ μ΄λ¥Ό λ³Ό μ μμ

* λ§μ•½ μ—”ν‹°ν‹° ν•„λ“λ…μ΄ λ°”λ€μ—λ‹¤λ©΄ λ©”μ†λ“ λ…λ„ λ°”κΏ”μ£Όμ–΄μ•Ό μ¤λ¥κ°€ λ°μƒ μ•ν•¨

### 2. JPA NamedQuery

* μΏΌλ¦¬μ— μ΄λ¦„μ„ λ¶€μ—¬ν•μ—¬ μ‚¬μ©

  ```java
  @Entity
  @NamedQuery (
      name="Member.findByUsername",
      query="select m from Member m where m.username = :username")
  public class Member {
      ...
  }
  
  public interface MemberRepository extends JpaRepository<Member, Long> {
      List<Member> findByUsername(@Param("username") String username);
  }
  ```

* μ¤ν”„λ§ λ°μ΄ν„° JPAλ” μ„ μ–Έν• "λ„λ©”μΈ ν΄λμ¤ + . + λ©”μ†λ“ μ΄λ¦„"μΌλ΅ Named μΏΌλ¦¬λ¥Ό μ°Ύμ•„μ„ μ‹¤ν–‰  
  λ§μΌ μ‹¤ν–‰ν•  Named μΏΌλ¦¬κ°€ μ—†λ” κ²½μ° λ©”μ†λ“ μ΄λ¦„μΌλ΅ μΏΌλ¦¬ μƒμ„± μ „λµμ„ μ‚¬μ©

### 3. @Query, λ¦¬ν¬μ§€ν† λ¦¬ λ©”μ†λ“μ— μΏΌλ¦¬ μ •μ

* λ©”μ†λ“μ— μ§μ ‘ μΏΌλ¦¬λ¥Ό μ •μν•κΈ° μ„ν•΄μ„λ” `@Query` μ–΄λ…Έν…μ΄μ…μ„ μ‚¬μ©
* μ‹¤ν–‰ν•  λ©”μ†λ“μ— μ •μ  μΏΌλ¦¬λ¥Ό μ§μ ‘ μ‘μ„±ν•λ” κ²ƒμΌλ΅ μ΄λ¦„μ—†λ” Named μΏΌλ¦¬λΌ ν•  μ μμ
* λ§μ•½ μλ»λμ—λ‹¤λ©΄ μ‹¤ν–‰ μ‹μ μ—μ„ λ¬Έλ²• μ¤λ¥ λ°μƒ
* λ„¤μ΄ν‹°λΈ SQLμ„ μ‚¬μ©ν•κ³  μ‹¶μΌλ©΄ `nativeQuery = true` μ„¤μ •

### 4. νλΌλ―Έν„° λ°”μΈλ”©

* μ„μΉ κΈ°λ° νλΌλ―Έν„° λ°”μΈλ”©κ³Ό μ΄λ¦„ κΈ°λ° νλΌλ―Έν„° λ°”μΈλ”© λ¨λ‘ μ§€μ›(κΈ°λ³Έκ°’ β†’ μ„μΉ κΈ°λ°)

* μ΄λ¦„ κΈ°λ°μΌλ΅ μ‚¬μ©ν•κΈ° μ„ν•΄μ„λ” `@Param` μ–΄λ…Έν…μ΄μ…μ„ μ‚¬μ©

  ```java
  @Query("select m from Member m where m.username = :name")
  Member findByUsername(@Param("name") String username);
  ```

### 5. λ²ν¬μ„± μμ • μΏΌλ¦¬

* λ²ν¬μ„± μμ • μ‚­μ  μΏΌλ¦¬λ” `@Modifying` μ–΄λ…Έν…μ΄μ…μ„ μ‚¬μ©, μ΄ν›„ μμ†μ„± μ»¨ν…μ¤νΈλ¥Ό μ΄κΈ°ν™” ν•λ ¤λ©΄ `clearAutomatically = true`μ™€ κ°™μ΄ μ„¤μ •(κΈ°λ³Έκ°’ β†’ false)

### 6. λ°ν™ νƒ€μ…

* κ²°κ³Όκ°€ λ‹¨κ±΄μΌ λ•λ” λ°ν™ νƒ€μ… μ§€μ •, ν• κ±΄ μ΄μƒμ€ μ»¬λ ‰μ… μΈν„°νμ΄μ¤ μ‚¬μ©
* κ²°κ³Όκ°€ μ—†λ‹¤λ©΄ λ‹¨κ±΄μ€ null, ν• κ±΄ μ΄μƒμ€ λΉ μ»¬λ ‰μ…μ„ λ°ν™
* λ‹¨κ±΄μΌλ΅ μ§€μ •ν• λ©”μ†λ“λ¥Ό νΈμ¶ μ‹μ—λ” `Query.getSingleResult()` λ©”μ†λ“λ¥Ό νΈμ¶ν•λ©° λ§μ•½ κ²°κ³Όκ°€ μ—†μ„ λ•λ” NoResultException μμ™Έλ¥Ό λ¬΄μ‹ν•κ³  nullμ„ λ°ν™

### 7. νμ΄μ§•κ³Ό μ •λ ¬

* μΏΌλ¦¬ λ©”μ†λ“μ— νμ΄μ§•κ³Ό μ •λ ¬ κΈ°λ¥μ„ μ‚¬μ©ν•  μ μλ„λ΅ 2κ°€μ§€ νΉλ³„ν• νλΌλ―Έν„°λ¥Ό μ κ³µ(Sorting, Pageable)
* Pageableμ„ μ‚¬μ©ν•λ©΄ λ°ν™ νƒ€μ…μΌλ΅ List νΉμ€ Pageλ¥Ό μ‚¬μ© κ°€λ¥
* Pageμ κ²½μ°, νμ΄μ§€ κΈ°λ¥μ„ μ κ³µν•κΈ° μ„ν•΄ κ²€μƒ‰λ μ „μ²΄ λ°μ΄ν„° κ±΄μλ¥Ό μ΅°νν•λ” COUNT μΏΌλ¦¬λ¥Ό μ¶”κ°€λ΅ νΈμ¶
* Pageableμ€ μΈν„°νμ΄μ¤μ΄κΈ° λ•λ¬Έμ— μ΄λ¥Ό κµ¬ν„ν• PageRequest κ°μ²΄λ¥Ό μ‚¬μ©

### 8. ννΈ

* ννΈλ¥Ό μ‚¬μ©ν•λ ¤λ©΄ `@QueryHints` μ–΄λ…Έν…μ΄μ…μ„ μ‚¬μ©, μ΄λ” JPA κµ¬ν„μ²΄μ—κ² μ κ³µν•λ” ννΈ

### 9 Lock

* μΏΌλ¦¬ μ‹μ— Lockμ„ κ±Έλ ¤λ©΄ `@Lock` μ–΄λ…Έν…μ΄μ…μ„ μ‚¬μ©

<br>

## 12.5 λ…μ„Έ

* λ…μ„Έλ¥Ό μ΄ν•΄ν•κΈ° μ„ν• ν•µμ‹¬ λ‹¨μ–΄λ” μ μ–΄(μ„μ μ–΄), μ΄λ” λ‹¨μν μ°Έμ΄λ‚ κ±°μ§“μΌλ΅ ν‰κ°€λλ©° AND, ORμ™€ κ°™μ€ μ—°μ‚°μλ΅ μ΅°ν•© κ°€λ¥

* λ°μ΄ν„°λ¥Ό κ²€μƒ‰ν•κΈ° μ„ν• μ μ•½ μ΅°κ±΄ ν•λ‚ν•λ‚λ¥Ό μ μ–΄ (μ΄λ¦„μ€ ~~μ΄κ³ , λ‚μ΄λ” ~~μ΄μƒ)

* μ¤ν”„λ§ λ°μ΄ν„° JPAμ—μ„λ” Specification ν΄λμ¤(μ»΄ν¬μ§€νΈ ν¨ν„΄)λ΅ μ •μ

  ```
  # μ»΄νΌμ§€νΈ ν¨ν„΄
  
  μ»΄νΌμ§€νΈ ν¨ν„΄μ€ λ‹¨μΌ κ°μ²΄μ™€ κ·Έ κ°μ²΄λ“¤μ„ κ°€μ§€λ” μ§‘ν•© κ°μ²΄λ¥Ό
  κ°™μ€ νƒ€μ…μΌλ΅ μ·¨κΈ‰ν•λ©°, νΈλ¦¬ κµ¬μ΅°λ΅ κ°μ²΄λ“¤μ„ μ—®λ” ν¨ν„΄
  ```

* λ…μ„Έλ¥Ό μ •μν•κΈ°μ„ν€μ„λ” Specification μΈν„°νμ΄μ¤λ¥Ό κµ¬ν„

<br>

## 12.6 μ‚¬μ©μ μ •μ λ¦¬ν¬μ§€ν† λ¦¬ κµ¬ν„

* μ§μ ‘ κµ¬ν„μ΄ ν•„μ”ν• μκ°„μ—λ” μ‚¬μ©μ μ •μ λ¦¬ν¬μ§€ν† λ¦¬λ¥Ό κµ¬ν„ν•μ—¬ μ‚¬μ©

  ```java
  public interface MemberRepositoryCustom {
      public List<Member> findMemberCustom();
  }
  
  public class MemberRepositoryImpl implements MemberRepositoryCustom {
      @Override
      public List<Member> findMemberCustom() {
          ...
      }
  }
  ```

* μ‚¬μ©μ μ •μ λ¦¬ν¬μ§€ν† λ¦¬μ μΈν„°νμ΄μ¤λ¥Ό κµ¬ν„ν• ν΄λμ¤λ” "μΈν„°νμ΄μ¤ μ΄λ¦„ + Impl" λ΅ μ§€μ–΄μ•Ό ν•λ” κ·μΉ™ μ΅΄μ¬(μ„¤μ • κ°€λ¥)

* μ΄ν›„ μ‚¬μ©μ μ •μ λ¦¬ν¬μ§€ν† λ¦¬ μΈν„°νμ΄μ¤λ¥Ό μƒμ† λ°›μ•„μ„ μ‚¬μ©

<br>

## 12.7 Web ν™•μ¥

### 1. μ„¤μ •

* Web ν™•μ¥ κΈ°λ¥μ„ ν™μ„±ν™” ν•κΈ° μ„ν•΄μ„λ” SpringDataWebConfigurationμ„ μ¤ν”„λ§ λΉμΌλ΅ λ“±λ΅ νΉμ€ Config ν΄λμ¤μ— `@EnableSpringDataWebSupport` μ–΄λ…Έν…μ΄μ…μ„ μ¶”κ°€
* μ΄λ¥Ό μ„¤μ •ν•λ©΄ λ„λ©”μΈ ν΄λμ¤ μ»¨λ²„ν„°μ™€ HandleMethodArgumentResolverκ°€ λΉμΌλ΅ λ“±λ΅

### 2. λ„λ©”μΈ ν΄λμ¤ μ»¨λ²„ν„°

* HTTP νλΌλ―Έν„°λ΅ λ„μ–΄μ¨ μ—”ν‹°ν‹°μ μ•„μ΄λ””λ΅ μ—”ν‹°ν‹° κ°μ²΄λ¥Ό μ°Ύμ•„ λ°”μΈλ”©

  ```java
  @RequestMapping("member/updateForm")
  													// λ°”μΈλ”© λ¶€λ¶„
  public String memberUpdateForm(@RequestParam("id") Member member) {}
  ```

* λ„λ©”μΈ ν΄λμ¤ μ»¨λ²„ν„°λ¥Ό μ΄μ©ν•μ—¬ λ„μ–΄μ¨ μ—”ν‹°ν‹°λ” μμ •ν•΄λ„ μ‹¤μ  λ°μ΄ν„°λ² μ΄μ¤μ— μ μ©μ΄ μ•λ¨(μ΄λ” 13μ¥μ—μ„ μμ„Έν μ•μ•„λ³Ό μμ •)

### 3. νμ΄μ§• μ •λ ¬ κΈ°λ¥

* νμ΄μ§• κΈ°λ¥ β†’ PageableHandlerMethodArgumentResolver

  μ •λ ¬ κΈ°λ¥ β†’ SortHandlerMethodArgumentResolver

* νλΌλ―Έν„°λ΅ Pageableμ„ λ°›μΌλ©° μ΄λ” λ‹¤μκ³Ό κ°™μ€ μ •λ³΄λ΅ λ§λ“¤μ–΄ μ§

  * page

    > ν„μ¬ νμ΄μ§€λ΅ 0λ¶€ν„° μ‹μ‘

  * size

    > ν• νμ΄μ§€μ— λ…Έμ¶ν•  λ°μ΄ν„° μ

  * sort

    > μ •λ ¬ μ΅°κ±΄ μ •μ

  ```java
  @GetMapping("members")
  public String list(Pageable pageable, Model model) {}
  
  // μ”μ²­ 
  // /members?page=0&size=10&sort=name,desc
  ```

* μ‚¬μ©ν•΄μ•Ό ν•  νμ΄μ§• μ •λ³΄κ°€ λ‘ μ΄μƒμ΄λ©΄ μ ‘λ‘μ‚¬λ¥Ό μ‚¬μ©ν•μ—¬ κµ¬λ¶„, μ΄λ” `@Qualifier` μ–΄λ…Έν…μ΄μ…μ„ μ‚¬μ©ν•μ—¬ μ‘μ„±

  ```java
  public String list(
  	@Qualifier("member") Pageable memberPageable,
      @Qualifier("team") Pageable teamPageable
  ) {}
  
  // μ”μ²­ 
  // /members?member_page=0&team_page=1
  ```

* Pageableμ κΈ°λ³Έκ°’μ€ page = 0, size = 20μΌλ΅ λ³€κ²½ν•λ ¤λ©΄ `@PageableDefault` μ–΄λ…Έν…μ΄μ…μ„ μ‚¬μ©

<br>

## 12.8 μ¤ν”„λ§ λ°μ΄ν„° JPAκ°€ μ‚¬μ©ν•λ” κµ¬ν„μ²΄

> μƒλµ

<br>

## 12.9 JPA μƒµμ— μ μ©

> μƒλµ

<br>

## 12.10 μ¤ν”„λ§ λ°μ΄ν„° JPAμ™€ QueryDSL ν†µν•©

### 1. QueryDslPredicateExecutor μ‚¬μ©

* QueryDslPredicateExecutor λ¥Ό λ¦¬ν¬μ§€ν† λ¦¬μ—μ„ μƒμ† λ°›μ•„ μ‚¬μ©

  ```java
  // μ •μ
  public interface ItemRepository extends JpaRepository<Item, Long>,
  										QueryDslPredicateExecutor<Item>{ }
  
  // μ‹¤μ  μ‚¬μ©
  QItem item = QItem.item;
  Iterable<Item> result = itemRepository.findAll(item.name.contain("λ§¥λ¶"));
  ```

* νμ΄μ§•κ³Ό μ •λ ¬ κΈ°λ¥λ„ ν•¨κ» μ‚¬μ© κ°€λ¥

* QueryDSLμ„ μ‚¬μ© κ°€λ¥ν•μ§€λ§ join, fetch κ°™μ€ κΈ°λ¥μ„ μ‚¬μ©ν•  μ μ—†μ  
  λ”°λΌμ„ λ‹¤μ–‘ν• κΈ°λ¥μ„ μ‚¬μ©ν•κΈ° μ„ν•΄μ„λ” JPAQueryλ¥Ό μ§μ ‘ μ‚¬μ©ν•κ±°λ‚ QueryDslRepositorySupportλ¥Ό μ‚¬μ©

### 2. QueryDslRepositorySupport μ‚¬μ©

* μ‚¬μ©μ μ •μ λ¦¬ν¬μ§€ν† λ¦¬λ¥Ό κµ¬ν„ν•λ” κµ¬ν„μ²΄μ—μ„ QueryDslRepositorySupportλ¥Ό μƒμ†λ°›μ•„ λ©”μ†λ“λ¥Ό κµ¬ν„

  ```java
  public class MemberRepositoryImpl implements QueryDslRepositorySupport {
      @Override
      public List<Order> search(OrderSearch orderSearch) {
          ...
      }
  }
  ```

